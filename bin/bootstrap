#!/bin/bash

set -e

is_macos() {
    [ "$(uname -s)" = "Darwin" ]
}

is_linux() {
    [ "$(uname -s)" = "Linux" ]
}

debug() {
    if [ "${DEBUG:-false}" = "true" ]; then
        # Use gdate if available (GNU coreutils on macOS), otherwise use standard date without milliseconds
        if command -v gdate &> /dev/null; then
            timestamp=$(gdate '+%H:%M:%S.%3N')
        else
            timestamp=$(date '+%H:%M:%S')
        fi
        echo "[$timestamp] $1"
    fi
}

ensure_sudo() {
    if [ "$(id -u)" -ne 0 ] && ! command -v sudo &> /dev/null; then
        echo "Error: sudo is required but not available"
        exit 1
    fi
}

run_with_sudo() {
    if [ "$(id -u)" -eq 0 ]; then
        "$@"
    else
        sudo "$@"
    fi
}

brew_quiet() {
    if [ "${DEBUG:-false}" = "true" ]; then
        HOMEBREW_NO_AUTO_UPDATE=1 brew "$@"
    else
        HOMEBREW_NO_AUTO_UPDATE=1 brew "$@" >/dev/null 2>&1
    fi
}

bootstrap_homebrew() {
    if ! is_macos; then
        return 0
    fi

    if ! command -v brew &> /dev/null; then
        debug "Installing Homebrew..."
        NONINTERACTIVE=1 /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
    fi

    local brew_bin=""
    if command -v brew &> /dev/null; then
        brew_bin="$(command -v brew)"
    elif [ -x /opt/homebrew/bin/brew ]; then
        brew_bin="/opt/homebrew/bin/brew"
    elif [ -x /usr/local/bin/brew ]; then
        brew_bin="/usr/local/bin/brew"
    elif [ -x /home/linuxbrew/.linuxbrew/bin/brew ]; then
        brew_bin="/home/linuxbrew/.linuxbrew/bin/brew"
    fi

    if [ -z "$brew_bin" ]; then
        echo "Error: Homebrew installation completed but 'brew' was not found"
        exit 1
    fi

    local zprofile_path="$HOME/.zprofile"
    local shellenv_line
    shellenv_line="$(printf 'eval \"$(%s shellenv)\"' "$brew_bin")"

    if ! grep -Fq "brew shellenv" "$zprofile_path" 2>/dev/null; then
        printf '%s\n' "$shellenv_line" >> "$zprofile_path"
    fi

    eval "$("$brew_bin" shellenv -s bash)"
}

bootstrap_debian_prereqs() {
    if ! is_linux; then
        return 0
    fi

    ensure_sudo
    debug "Installing Debian prerequisites..."
    run_with_sudo apt-get update -y
    run_with_sudo env DEBIAN_FRONTEND=noninteractive apt-get install -y \
        ca-certificates \
        curl \
        git \
        gnupg \
        build-essential \
        libssl-dev \
        libreadline-dev \
        zlib1g-dev \
        libyaml-dev \
        libffi-dev \
        libgdbm-dev \
        libncurses5-dev \
        libdb-dev \
        libbz2-dev \
        liblzma-dev \
        libsqlite3-dev \
        pkg-config \
        unzip \
        xz-utils
}

bootstrap_mise() {
    if ! command -v mise &> /dev/null; then
        debug "Installing mise..."
        if is_macos; then
            brew_quiet install mise
        else
            curl -fsSL https://mise.jdx.dev/install.sh | sh
            if [ -d "$HOME/.local/bin" ]; then
                export PATH="$HOME/.local/bin:$PATH"
            fi
        fi
    else
        debug "mise already installed"
    fi

    # Trust mise config in current directory (needed for non-interactive environments)
    if [ -f ".mise.toml" ]; then
        debug "Trusting mise config..."
        mise trust --yes 2>/dev/null || true
    fi

    eval "$(mise activate bash)"
}

bootstrap_gum() {
    if ! command -v gum &> /dev/null; then
        if command -v mise &> /dev/null; then
            debug "Installing gum via mise..."
            mise use --global gum@latest >/dev/null
            mise install gum@latest >/dev/null
        else
            debug "Installing gum..."
            if is_macos; then
                brew_quiet install gum
            else
                ensure_sudo
                run_with_sudo env DEBIAN_FRONTEND=noninteractive apt-get install -y gum || true
            fi
        fi
    else
        debug "gum already installed"
    fi
}

bootstrap_ruby() {
    # Check if we have a suitable Ruby already installed
    if command -v ruby &> /dev/null; then
        local current_version
        current_version=$(ruby -v | grep -oE '[0-9]+\.[0-9]+\.[0-9]+' | head -1)
        local major_version
        major_version=$(echo "$current_version" | cut -d. -f1)

        # In CI, accept any Ruby 3.x+ to avoid slow source builds
        if [ "${CI:-}" = "true" ] && [ "$major_version" -ge 3 ]; then
            debug "CI mode: Ruby $current_version is sufficient (>= 3.x), skipping mise Ruby installation"
            return
        fi

        # Resolve what ruby@latest actually means
        local latest_version
        latest_version=$(mise latest ruby)

        if [ "$current_version" = "$latest_version" ]; then
            debug "Ruby $current_version already installed (matches ruby@latest), skipping mise Ruby installation"
            return
        else
            debug "Ruby $current_version installed but ruby@latest is $latest_version"
        fi
    fi

    # Resolve what ruby@latest actually means (if not already resolved)
    local latest_version
    latest_version=${latest_version:-$(mise latest ruby)}

    debug "Installing Ruby $latest_version via mise..."
    mise use --global ruby@latest >/dev/null
    mise install ruby@latest >/dev/null

    debug "Ruby bootstrap complete. Modern Ruby should now be available."
}

main() {
    debug "Bootstrapping development environment..."

    bootstrap_homebrew
    bootstrap_debian_prereqs
    bootstrap_mise
    bootstrap_ruby
    bootstrap_gum

    debug "Bootstrap complete."
}

main "$@"
